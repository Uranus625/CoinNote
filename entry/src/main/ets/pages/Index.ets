import { promptAction } from '@kit.ArkUI';
import common from '@ohos.app.ability.common';
import BillRdb from '../db/BillRdb';
import { BillItem } from '../model/BillItem';

// æ˜¾å¼å®šä¹‰æ‰€æœ‰éœ€è¦çš„æ ·å¼æ¥å£
interface SelectOption {
  value: string;
  icon?: Resource;
}

// ç»Ÿè®¡æ•°æ®æ¥å£
interface MonthlyStats {
  totalIncome: number;
  totalExpense: number;
  balance: number;
}

// æ¯æ—¥åˆ†ç»„æ¥å£
interface DayGroup {
  date: string;
  dayIncome: number;
  dayExpense: number;
  bills: BillItem[];
}

// é¥¼å›¾æ•°æ®æ¥å£
interface PieData {
  category: string;
  amount: number;
  percentage: number;
  color: string;
}

// æ¯æ—¥è¶‹åŠ¿æ•°æ®æ¥å£
interface DailyData {
  day: number;
  amount: number;
}

@Component
struct FormCard {
  @Prop title: string = "";
  @BuilderParam content: () => void = this.emptyBuilder;

  @Builder emptyBuilder() {}

  build() {
    Column() {
      Text(this.title)
        .fontSize(14)
        .fontColor("#666666")
        .margin({ bottom: 8 })
        .width("100%")
      
      Column() {
        this.content()
      }
      .width("100%")
      .backgroundColor(Color.White)
      .borderRadius(12)
      .padding(12)
      .shadow({ radius: 4, color: "#0D000000", offsetY: 2 }) // æŸ”å’Œé˜´å½±
    }
    .width("100%")
    .margin({ bottom: 16 })
  }
}

@Entry
@Component
struct CoinNote {
  // çŠ¶æ€å˜é‡
  @State currentTab: number = 0;
  @State expenseType: string = "";
  @State amount: string = "";
  @State amountError: string = "";
  @State note: string = "";
  @State selectedDate: Date = new Date();
  @State dateStr: string = ""; // åˆå§‹åŒ–ä¸ºç©ºï¼Œåœ¨aboutToAppearä¸­è®¾ç½®
  @State payType: string = "å¾®ä¿¡";
  @State tags: string[] = [];
  @State isReimbursable: boolean = false;
  @State billDirection: 'expense' | 'income' = 'expense'; // ä¿®æ”¹ï¼šé¿å…ä¸ç³»ç»Ÿå±æ€§å†²çª
  @State chartWidth: number = 300; // å›¾è¡¨å®½åº¦ï¼Œé»˜è®¤300ï¼Œé€šè¿‡onAreaChangeæ›´æ–°
  @State chartHeight: number = 150; // å›¾è¡¨é«˜åº¦
  @State statsDate: Date = new Date(); // ç»Ÿè®¡é¡µé¢çš„é€‰ä¸­æ—¥æœŸ
  @State statsType: 'expense' | 'income' = 'expense'; // ç»Ÿè®¡ç±»å‹
  @State searchText: string = ""; // æœç´¢å…³é”®å­—
  @State editingBillId: number = 0; // æ­£åœ¨ç¼–è¾‘çš„è´¦å•IDï¼Œ0è¡¨ç¤ºæ–°å¢æ¨¡å¼
  
  // Canvasè®¾ç½®
  private settings: RenderingContextSettings = new RenderingContextSettings(true);
  private context: CanvasRenderingContext2D = new CanvasRenderingContext2D(this.settings);
  
  // æŸ±çŠ¶å›¾ Canvas è®¾ç½®
  private barSettings: RenderingContextSettings = new RenderingContextSettings(true);
  private barContext: CanvasRenderingContext2D = new CanvasRenderingContext2D(this.barSettings);

  // åŠ¨ç”»ç›¸å…³
  @State chartProgress: number = 0; // 0.0 -> 1.0

  // è§¦å‘å›¾è¡¨åŠ¨ç”»
  private animateCharts(): void {
    this.chartProgress = 0;
    let start = Date.now();
    const duration = 800; // 800ms åŠ¨ç”»æ—¶é•¿

    const step = (): void => {
      const now = Date.now();
      const progress = Math.min((now - start) / duration, 1);
      // ä½¿ç”¨ EaseOutCubic ç¼“åŠ¨å‡½æ•°è®©åŠ¨ç”»æ›´è‡ªç„¶: 1 - (1-x)^3
      this.chartProgress = 1 - Math.pow(1 - progress, 3);
      
      this.drawPieChart();
      this.drawBarChart();

      if (progress < 1) {
        setTimeout(step, 16); // çº¦ 60fps
      }
    };
    step();
  }

  // è´¦å•åˆ—è¡¨
  @State @Watch('onBillListChange') billList: BillItem[] = [];

  onBillListChange(): void {
    // æ•°æ®å˜åŒ–æ—¶è§¦å‘åŠ¨ç”»é‡ç»˜
    this.animateCharts();
  }

  aboutToAppear(): void {
    const now = new Date();
    this.dateStr = this.formatDate(now);
    
    // åˆå§‹åŒ–æ•°æ®åº“å¹¶åŠ è½½æ•°æ®
    const context = getContext(this) as common.UIAbilityContext;
    BillRdb.getRdbStore(context).then(() => {
      this.refreshBillList();
    }).catch((err: Error) => {
      console.error('DB Init failed', err);
    });
  }

  // åˆ·æ–°è´¦å•åˆ—è¡¨
  private refreshBillList(): void {
    BillRdb.queryAll().then((list) => {
      this.billList = list;
    });
  }

  // æ—¥æœŸæ ¼å¼åŒ– YYYY/M/D
  private formatDate(date: Date): string {
    return `${date.getFullYear()}/${date.getMonth() + 1}/${date.getDate()}`;
  }

  // é€‰é¡¹æ•°æ®
  private expenseTypes: string[] = ["é¤é¥®", "äº¤é€š", "è´­ç‰©", "å¨±ä¹", "æ°´ç”µç…¤", "æˆ¿ç§Ÿ", "é€šè®¯", "åŒ»ç–—", "å…¶ä»–"];
  private incomeTypes: string[] = ["å·¥èµ„", "å¥–é‡‘", "ç†è´¢", "å…¼èŒ", "ç¤¼é‡‘", "å…¶ä»–"]; // æ–°å¢ï¼šæ”¶å…¥ç±»å‹
  private payTypes: string[] = ["å¾®ä¿¡", "æ”¯ä»˜å®", "é“¶è¡Œå¡", "ç°é‡‘"];
  private tagOptions: string[] = ["æ—©é¤", "åˆé¤", "æ™šé¤", "å¤–å–", "åœ°é“", "å…¬äº¤", "è¶…å¸‚", "ç”µå½±", "é€šå‹¤", "æ—¥ç”¨å“", "èšé¤"];

  // ç”ŸæˆSelecté€‰é¡¹
  private getSelectOptions(): SelectOption[] {
    const types = this.billDirection === 'expense' ? this.expenseTypes : this.incomeTypes;
    return types.map((type: string): SelectOption => ({ value: type }));
  }

  // è·å–åˆ†ç±»é¢œè‰²
  private getCategoryColor(type: string): string {
    const colors: Record<string, string> = {
      "é¤é¥®": "#FF9500", // æ©™è‰²
      "äº¤é€š": "#007AFF", // è“è‰²
      "è´­ç‰©": "#FF2D55", // çº¢è‰²
      "å¨±ä¹": "#5856D6", // ç´«è‰²
      "æ°´ç”µç…¤": "#5AC8FA", // æµ…è“
      "æˆ¿ç§Ÿ": "#FFCC00", // é»„è‰²
      "é€šè®¯": "#4CD964", // ç»¿è‰²
      "åŒ»ç–—": "#FF3B30", // çº¢è‰²
      "å…¶ä»–": "#8E8E93", // ç°è‰²
      "å·¥èµ„": "#34C759", // ç»¿è‰²
      "å¥–é‡‘": "#FFD60A", // é‡‘è‰²
      "ç†è´¢": "#AF52DE", // ç´«è‰²
      "å…¼èŒ": "#5AC8FA", // æµ…è“
      "ç¤¼é‡‘": "#FF2D55"  // çº¢è‰²
    };
    return colors[type] || "#4A6CF7";
  }

  // é‡‘é¢æ ¡éªŒ
  private validateAmount(): boolean {
    if (this.amount === "") {
      this.amountError = "é‡‘é¢ä¸èƒ½ä¸ºç©º";
      return false;
    } else if (isNaN(Number(this.amount)) || Number(this.amount) <= 0) {
      this.amountError = "è¯·è¾“å…¥æœ‰æ•ˆçš„æ­£æ•°é‡‘é¢";
      return false;
    } else {
      this.amountError = "";
      return true;
    }
  }

  // æ·»åŠ æˆ–æ›´æ–°è´¦å•
  private addBill(): void {
    if (!this.validateAmount()) {
      promptAction.showToast({ message: 'è¯·æ£€æŸ¥é‡‘é¢è¾“å…¥', duration: 2000 });
      return;
    }
    if (this.expenseType === "") {
      promptAction.showToast({ message: 'è¯·é€‰æ‹©åˆ†ç±»', duration: 2000 });
      return;
    }

    const bill: BillItem = {
      id: this.editingBillId > 0 ? this.editingBillId : Date.now(),
      type: this.expenseType,
      amount: Number(this.amount),
      date: this.dateStr,
      payType: this.payType,
      tags: [...this.tags],
      isReimbursable: this.isReimbursable,
      note: this.note,
      direction: this.billDirection
    };

    // å®šä¹‰æ“ä½œ
    const doSave = () => {
      if (this.editingBillId > 0) {
        // æ›´æ–°
        BillRdb.update(bill).then(() => {
          promptAction.showToast({ message: 'ä¿®æ”¹æˆåŠŸï¼', duration: 2000 });
          this.refreshBillList();
          this.resetForm();
        }).catch((err: Error) => {
          console.error('Update failed', err);
          promptAction.showToast({ message: 'ä¿®æ”¹å¤±è´¥: ' + (err.message || JSON.stringify(err)), duration: 3000 });
        });
      } else {
        // æ–°å¢
        BillRdb.insert(bill).then(() => {
          promptAction.showToast({ message: 'è®°è´¦æˆåŠŸï¼', duration: 2000 });
          this.refreshBillList();
          this.resetForm();
        }).catch((err: Error) => {
          console.error('Insert failed', err);
          promptAction.showToast({ message: 'è®°è´¦å¤±è´¥: ' + (err.message || JSON.stringify(err)), duration: 3000 });
        });
      }
    };

    // æ£€æŸ¥æ•°æ®åº“æ˜¯å¦åˆå§‹åŒ–ï¼Œå¦‚æœæ²¡æœ‰åˆ™å°è¯•é‡æ–°åˆå§‹åŒ–
    if (!BillRdb.isInitialized()) {
      const context = getContext(this) as common.UIAbilityContext;
      BillRdb.getRdbStore(context).then(() => {
        doSave();
      }).catch((err: Error) => {
        // æå–æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
        const errorMsg = JSON.stringify(err) !== '{}' ? JSON.stringify(err) : err.message;
        promptAction.showToast({ message: 'DB Init Error: ' + errorMsg, duration: 5000 });
        console.error('DB Init Error Detail:', errorMsg);
      });
    } else {
      doSave();
    }
  }

  private resetForm(): void {
    this.editingBillId = 0; // é‡ç½®ç¼–è¾‘çŠ¶æ€
    this.expenseType = "";
    this.amount = "";
    this.note = "";
    this.tags = [];
    this.selectedDate = new Date();
    this.dateStr = this.formatDate(this.selectedDate);
    this.payType = "å¾®ä¿¡";
    this.isReimbursable = false;
    this.amountError = "";
    // ä¸é‡ç½® billDirectionï¼Œæ–¹ä¾¿è¿ç»­è®°è´¦
  }

  // å¼€å§‹ç¼–è¾‘
  private startEdit(bill: BillItem): void {
    this.editingBillId = bill.id;
    this.billDirection = bill.direction;
    this.expenseType = bill.type;
    this.amount = bill.amount.toString();
    this.dateStr = bill.date;
    this.selectedDate = new Date(bill.date);
    this.payType = bill.payType;
    this.tags = [...bill.tags];
    this.isReimbursable = bill.isReimbursable;
    this.note = bill.note;
    
    this.currentTab = 0; // åˆ‡æ¢åˆ°è®°è´¦é¡µ
  }

  // æ˜¾ç¤ºæ—¥æœŸé€‰æ‹©å™¨
  private showDatePicker(): void {
    DatePickerDialog.show({
      start: new Date("2020-1-1"),
      end: new Date("2100-12-31"),
      selected: this.selectedDate,
      onAccept: (value: DatePickerResult) => {
        // value.month is 0-indexed
        const year = value.year;
        const month = value.month;
        const day = value.day;
        if (year !== undefined && month !== undefined && day !== undefined) {
           this.selectedDate = new Date(year, month, day);
           this.dateStr = this.formatDate(this.selectedDate);
        }
      }
    })
  }

  // åˆ é™¤è´¦å•
  private deleteBill(id: number): void {
    // å¼¹çª—ç¡®è®¤
    AlertDialog.show({
      title: 'ç¡®è®¤åˆ é™¤',
      message: 'ç¡®å®šè¦åˆ é™¤è¿™æ¡è´¦å•è®°å½•å—ï¼Ÿ',
      primaryButton: {
        value: 'å–æ¶ˆ',
        action: () => {}
      },
      secondaryButton: {
        value: 'åˆ é™¤',
        fontColor: Color.Red,
        action: () => {
          BillRdb.delete(id).then(() => {
            promptAction.showToast({ message: 'å·²åˆ é™¤', duration: 2000 });
            this.refreshBillList();
          });
        }
      }
    })
  }

  // ä¾§æ»‘åˆ é™¤æŒ‰é’®
  @Builder itemEnd(id: number) {
    Row() {
      Button("åˆ é™¤")
        .type(ButtonType.Normal)
        .width(80)
        .height("100%")
        .backgroundColor(Color.Red)
        .fontColor(Color.White)
        .onClick(() => {
          this.deleteBill(id);
        })
    }
    .padding({ left: 12 })
    .justifyContent(FlexAlign.End)
  }

  // è·å–æœ¬æœˆç»Ÿè®¡æ•°æ®
  private getMonthlyStats(): MonthlyStats {
    const currentMonth = this.statsDate.getMonth();
    const currentYear = this.statsDate.getFullYear();
    
    let totalIncome = 0;
    let totalExpense = 0;
    
    this.billList.forEach(bill => {
      // æ‰‹åŠ¨è§£ææ—¥æœŸå­—ç¬¦ä¸² YYYY/M/D
      const parts = bill.date.split('/');
      if (parts.length === 3) {
        const year = parseInt(parts[0]);
        const month = parseInt(parts[1]) - 1; // month is 0-indexed
        const day = parseInt(parts[2]);
        
        if (month === currentMonth && year === currentYear) {
          if (bill.direction === 'income') {
            totalIncome += bill.amount;
          } else {
            totalExpense += bill.amount;
          }
        }
      }
    });
    
    return { totalIncome, totalExpense, balance: totalIncome - totalExpense };
  }

  // æŒ‰æ—¥æœŸåˆ†ç»„è´¦å•
  private getGroupedBills(): DayGroup[] {
    const groups: Record<string, DayGroup> = {};
    const keyword = this.searchText.trim().toLowerCase();
    
    this.billList.forEach((bill: BillItem): void => {
      // æœç´¢è¿‡æ»¤é€»è¾‘
      if (keyword) {
        const matchType = bill.type.toLowerCase().includes(keyword);
        const matchNote = bill.note.toLowerCase().includes(keyword);
        const matchAmount = bill.amount.toString().includes(keyword);
        const matchTags = bill.tags.some((tag: string): boolean => tag.toLowerCase().includes(keyword));
        // å¦‚æœæ˜¯æŠ¥é”€å•ï¼Œä¸”å…³é”®å­—åŒ…å«åœ¨"æŠ¥é”€"ä¸­ï¼ˆä¾‹å¦‚æœ"æŠ¥"ã€"é”€"æˆ–"æŠ¥é”€"ï¼‰ï¼Œåˆ™åŒ¹é…
        const matchReimbursable = bill.isReimbursable && 'æŠ¥é”€'.includes(keyword);
        
        if (!matchType && !matchNote && !matchAmount && !matchTags && !matchReimbursable) {
          return; // å¦‚æœéƒ½ä¸åŒ¹é…ï¼Œè·³è¿‡è¯¥æ¡ç›®
        }
      }

      if (!groups[bill.date]) {
        groups[bill.date] = {
          date: bill.date,
          dayIncome: 0,
          dayExpense: 0,
          bills: []
        };
      }
      
      const group = groups[bill.date];
      group.bills.push(bill);
      if (bill.direction === 'income') {
        group.dayIncome += bill.amount;
      } else {
        group.dayExpense += bill.amount;
      }
    });
    
    // è½¬æ¢ä¸ºæ•°ç»„å¹¶æŒ‰æ—¥æœŸå€’åºæ’åº
    return Object.values(groups).sort((a: DayGroup, b: DayGroup): number => {
      return new Date(b.date).getTime() - new Date(a.date).getTime();
    });
  }

  // åˆ†ç»„å¤´éƒ¨ç»„ä»¶
  @Builder groupHeader(group: DayGroup) {
    Row() {
      Text(group.date)
        .fontSize(14)
        .fontColor("#666666")
        .fontWeight(FontWeight.Bold)
      
      Blank()
      
      Row() {
        if (group.dayIncome > 0) {
          Text(`æ”¶ ${group.dayIncome.toFixed(2)}`)
            .fontSize(12)
            .fontColor("#999999")
            .margin({ right: 12 })
        }
        
        if (group.dayExpense > 0) {
          Text(`æ”¯ ${group.dayExpense.toFixed(2)}`)
            .fontSize(12)
            .fontColor("#999999")
        }
      }
    }
    .width("100%")
    .padding({ left: 16, right: 16, top: 12, bottom: 8 })
    .backgroundColor("#F9FAFB") 
  }

  // æ˜¾ç¤ºç»Ÿè®¡æ—¥æœŸé€‰æ‹©å™¨
  private showStatsDatePicker(): void {
    DatePickerDialog.show({
      start: new Date("2020-1-1"),
      end: new Date("2100-12-31"),
      selected: this.statsDate,
      onAccept: (value: DatePickerResult) => {
        const year = value.year;
        const month = value.month;
        if (year !== undefined && month !== undefined) {
           // åªéœ€è¦å¹´æœˆï¼Œæ—¥è®¾ä¸º1
           this.statsDate = new Date(year, month, 1);
           // æ—¥æœŸæ”¹å˜åé‡ç»˜
           setTimeout((): void => { 
             this.animateCharts();
           }, 100);
        }
      }
    })
  }

  // è·å–é¥¼å›¾æ•°æ®
  private getPieData(): PieData[] {
    const currentMonth = this.statsDate.getMonth();
    const currentYear = this.statsDate.getFullYear();
    const typeMap: Record<string, number> = {};
    let total = 0;

    this.billList.forEach((bill: BillItem): void => {
      const parts = bill.date.split('/');
      if (parts.length === 3) {
        const year = parseInt(parts[0]);
        const month = parseInt(parts[1]) - 1;
        
        if (month === currentMonth && year === currentYear && bill.direction === this.statsType) {
          if (!typeMap[bill.type]) {
            typeMap[bill.type] = 0;
          }
          typeMap[bill.type] += bill.amount;
          total += bill.amount;
        }
      }
    });

    if (total === 0) return [];

    const result: PieData[] = Object.keys(typeMap).map((type: string): PieData => {
      return {
        category: type,
        amount: typeMap[type],
        percentage: typeMap[type] / total,
        color: this.getCategoryColor(type)
      } as PieData;
    });

    // æŒ‰é‡‘é¢é™åºæ’åº
    return result.sort((a: PieData, b: PieData): number => b.amount - a.amount);
  }

  // ç»˜åˆ¶é¥¼å›¾
  private drawPieChart(): void {
    // ç¡®ä¿contextå·²åˆå§‹åŒ–
    if (!this.context) return;
    
    const width = this.context.width;
    const height = this.context.height;
    const radius = Math.min(width, height) / 2 * 0.8;
    const centerX = width / 2;
    const centerY = height / 2;

    this.context.clearRect(0, 0, width, height);

    const data = this.getPieData();
    if (data.length === 0) {
      // ç©ºçŠ¶æ€ç»˜åˆ¶
      this.context.beginPath();
      this.context.arc(centerX, centerY, radius, 0, 2 * Math.PI);
      this.context.fillStyle = '#F0F2F5';
      this.context.fill();
      
      this.context.fillStyle = '#999999';
      this.context.font = '14vp sans-serif';
      this.context.textAlign = 'center';
      this.context.textBaseline = 'middle';
      this.context.fillText('æš‚æ— æ•°æ®', centerX, centerY);
      return;
    }

    let startAngle = -0.5 * Math.PI; // ä»12ç‚¹é’Ÿæ–¹å‘å¼€å§‹

    data.forEach((item: PieData): void => {
      // åŠ¨ç”»ï¼šæ ¹æ®è¿›åº¦è®¡ç®—å½“å‰æ‰‡åŒºçš„æ‰«æè§’åº¦
      const sliceAngle = item.percentage * 2 * Math.PI * this.chartProgress;
      const endAngle = startAngle + sliceAngle;

      this.context.beginPath();
      this.context.moveTo(centerX, centerY);
      this.context.arc(centerX, centerY, radius, startAngle, endAngle);
      this.context.closePath();
      this.context.fillStyle = item.color;
      this.context.fill();

      // ç»˜åˆ¶ç™½è‰²åˆ†å‰²çº¿ (ä»…å½“æœ‰è¿›åº¦æ—¶æ˜¾ç¤º)
      if (this.chartProgress > 0.1) {
        this.context.beginPath();
        this.context.moveTo(centerX, centerY);
        this.context.arc(centerX, centerY, radius, startAngle, endAngle);
        this.context.strokeStyle = '#FFFFFF';
        this.context.lineWidth = 2;
        this.context.stroke();
      }

      startAngle = endAngle;
    });
    
    // ç»˜åˆ¶ä¸­é—´çš„ç™½è‰²åœ†åœˆï¼Œå½¢æˆç”œç”œåœˆæ•ˆæœ
    this.context.beginPath();
    this.context.arc(centerX, centerY, radius * 0.6, 0, 2 * Math.PI);
    this.context.fillStyle = '#FFFFFF';
    this.context.fill();
    
    // ä¸­é—´æ˜¾ç¤ºæ€»é‡‘é¢ (å¸¦é€æ˜åº¦åŠ¨ç”»)
    const total = data.reduce((sum: number, item: PieData): number => sum + item.amount, 0);
    
    // ç®€å•çš„æ·¡å…¥æ•ˆæœ
    this.context.globalAlpha = this.chartProgress; 
    
    this.context.fillStyle = '#333333';
    this.context.font = 'bold 16vp sans-serif';
    this.context.textAlign = 'center';
    this.context.textBaseline = 'middle';
    this.context.fillText(this.statsType === 'expense' ? 'æ€»æ”¯å‡º' : 'æ€»æ”¶å…¥', centerX, centerY - 10);
    
    this.context.fillStyle = this.statsType === 'expense' ? '#333333' : '#34C759';
    this.context.font = 'bold 18vp sans-serif';
    // æ•°å­—æ»šåŠ¨æ•ˆæœ
    this.context.fillText((total * this.chartProgress).toFixed(2), centerX, centerY + 15);
    
    this.context.globalAlpha = 1.0; // æ¢å¤é€æ˜åº¦
  }

  // è·å–æ¯æ—¥è¶‹åŠ¿æ•°æ®
  private getDailyData(): DailyData[] {
    const currentYear = this.statsDate.getFullYear();
    const currentMonth = this.statsDate.getMonth();
    // è·å–å½“æœˆå¤©æ•°
    const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
    
    const dailyAmounts: number[] = new Array(daysInMonth).fill(0);

    this.billList.forEach((bill: BillItem): void => {
      const parts = bill.date.split('/');
      if (parts.length === 3) {
        const year = parseInt(parts[0]);
        const month = parseInt(parts[1]) - 1;
        const day = parseInt(parts[2]);
        
        if (month === currentMonth && year === currentYear && bill.direction === this.statsType) {
          if (day >= 1 && day <= daysInMonth) {
            dailyAmounts[day - 1] += bill.amount;
          }
        }
      }
    });

    return dailyAmounts.map((amount: number, index: number): DailyData => ({ day: index + 1, amount }));
  }

  // ç»˜åˆ¶æŸ±çŠ¶å›¾
  private drawBarChart(): void {
    if (!this.barContext) return;

    const width = this.barContext.width;
    const height = this.barContext.height;
    const padding = 20;
    const bottomPadding = 30;
    const topPadding = 20;
    
    this.barContext.clearRect(0, 0, width, height);

    const data = this.getDailyData();
    const maxAmount = Math.max(...data.map((d: DailyData): number => d.amount));
    
    if (maxAmount === 0) {
      this.barContext.fillStyle = '#999999';
      this.barContext.font = '14vp sans-serif';
      this.barContext.textAlign = 'center';
      this.barContext.textBaseline = 'middle';
      this.barContext.fillText('æš‚æ— è¶‹åŠ¿æ•°æ®', width / 2, height / 2);
      return;
    }

    const chartWidth = width - padding * 2;
    const chartHeight = height - topPadding - bottomPadding;
    const barWidth = (chartWidth / data.length) * 0.6;
    const spacing = (chartWidth / data.length) * 0.4;
    
    // ç»˜åˆ¶åæ ‡è½´çº¿
    this.barContext.beginPath();
    this.barContext.moveTo(padding, height - bottomPadding);
    this.barContext.lineTo(width - padding, height - bottomPadding);
    this.barContext.strokeStyle = '#E0E0E0';
    this.barContext.lineWidth = 1;
    this.barContext.stroke();

    data.forEach((item: DailyData, index: number): void => {
      const x = padding + index * (barWidth + spacing) + spacing / 2;
      // åŠ¨ç”»ï¼šé«˜åº¦éšè¿›åº¦å˜åŒ–
      const barHeight = (item.amount / maxAmount) * chartHeight * this.chartProgress;
      const y = height - bottomPadding - barHeight;

      // ç»˜åˆ¶æŸ±å­
      this.barContext.fillStyle = this.statsType === 'expense' ? '#4A6CF7' : '#34C759';
      // åœ†è§’çŸ©å½¢æ•ˆæœæ¨¡æ‹Ÿï¼ˆé¡¶éƒ¨åœ†è§’ï¼‰
      this.barContext.beginPath();
      this.barContext.rect(x, y, barWidth, barHeight);
      this.barContext.fill();

      // ç»˜åˆ¶æ—¥æœŸæ ‡ç­¾ï¼ˆæ¯éš”5å¤©æ˜¾ç¤ºä¸€æ¬¡ï¼Œæˆ–è€…æ˜¯ç¬¬ä¸€å¤©å’Œæœ€åä¸€å¤©ï¼‰
      // ä¼˜åŒ–ï¼šå¦‚æœ5çš„å€æ•°è·ç¦»æœ€åä¸€å¤©å¤ªè¿‘ï¼ˆ<2å¤©ï¼‰ï¼Œåˆ™ä¸æ˜¾ç¤ºï¼Œé¿å…ä¸æœ€åä¸€å¤©é‡å 
      const isFirst = item.day === 1;
      const isLast = item.day === data.length;
      const isMultipleOfFive = item.day % 5 === 0;
      const isSafeMultiple = isMultipleOfFive && (data.length - item.day > 1);

      // æ ‡ç­¾ä¹Ÿæ·»åŠ æ·¡å…¥åŠ¨ç”»
      if ((isFirst || isLast || isSafeMultiple) && this.chartProgress > 0.5) {
        this.barContext.globalAlpha = (this.chartProgress - 0.5) * 2;
        this.barContext.fillStyle = '#999999';
        this.barContext.font = '10vp sans-serif';
        this.barContext.textAlign = 'center';
        this.barContext.textBaseline = 'top';
        this.barContext.fillText(item.day.toString(), x + barWidth / 2, height - bottomPadding + 4);
        this.barContext.globalAlpha = 1.0;
      }
    });
  }

  // è‡ªå®šä¹‰ TabBar æ„å»ºå™¨
  @Builder TabBuilder(title: string, index: number, icon: string) {
    Column() {
      Text(icon)
        .fontSize(22)
        .margin({ bottom: 4 })
        .opacity(this.currentTab === index ? 1 : 0.5)
        .animation({ duration: 300 }) // æ·»åŠ ç®€å•çš„é€æ˜åº¦åŠ¨ç”»
      Text(title)
        .fontSize(10)
        .fontColor(this.currentTab === index ? "#4A6CF7" : "#999999")
        .fontWeight(this.currentTab === index ? FontWeight.Bold : FontWeight.Normal)
        .animation({ duration: 300 })
    }
    .justifyContent(FlexAlign.Center)
    .width('100%')
    .height('100%')
    .backgroundColor(Color.White)
  }

  build() {
    Column() {
      // é¡¶éƒ¨æ ‡é¢˜æ 
      Row() {
        // Logo
        Image($r('app.media.logo')) 
          .width(24)
          .height(24)
          .margin({ right: 8 })
          
        Text("CoinNote")
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor(Color.White)
      }
      .width("100%")
      .height(44)
      .linearGradient({
        angle: 90,
        colors: [[0x4A6CF7, 0.0], [0x4E54C8, 1.0]]
      })
      .padding({ left: 16, right: 16 })
      .alignItems(VerticalAlign.Center)
      .justifyContent(FlexAlign.Center) 

      // åº•éƒ¨æ ‡ç­¾é¡µ
      Tabs({ index: this.currentTab, barPosition: BarPosition.End }) {
        // æ ‡ç­¾é¡µ1ï¼šæ–°å¢è®°è´¦
        TabContent() {
          Scroll() {
            Column() {
              // 0. æ”¶æ”¯åˆ‡æ¢
              Row() {
                Button("æ”¯å‡º")
                  .type(ButtonType.Normal)
                  .backgroundColor(this.billDirection === 'expense' ? "#4A6CF7" : "#F0F2F5")
                  .fontColor(this.billDirection === 'expense' ? Color.White : "#666666")
                  .borderRadius({ topLeft: 8, bottomLeft: 8 })
                  .width("50%")
                  .height(36)
                  .onClick(() => {
                    this.billDirection = 'expense';
                    this.expenseType = ""; // åˆ‡æ¢æ—¶é‡ç½®åˆ†ç±»
                  })
                
                Button("æ”¶å…¥")
                  .type(ButtonType.Normal)
                  .backgroundColor(this.billDirection === 'income' ? "#34C759" : "#F0F2F5")
                  .fontColor(this.billDirection === 'income' ? Color.White : "#666666")
                  .borderRadius({ topRight: 8, bottomRight: 8 })
                  .width("50%")
                  .height(36)
                  .onClick(() => {
                    this.billDirection = 'income';
                    this.expenseType = ""; // åˆ‡æ¢æ—¶é‡ç½®åˆ†ç±»
                  })
              }
              .width("100%")
              .margin({ bottom: 16 })

              // 1. æ¶ˆè´¹ç±»å‹ï¼ˆä¸‹æ‹‰èœå•ï¼‰
              FormCard({ title: this.billDirection === 'expense' ? "æ¶ˆè´¹ç±»å‹ *" : "æ”¶å…¥ç±»å‹ *" }) {
                Select(this.getSelectOptions())
                  .value(this.expenseType || "è¯·é€‰æ‹©åˆ†ç±»")
                  .font({ size: 16 })
                  .fontColor(this.expenseType ? "#333333" : "#999999")
                  .selectedOptionFont({ size: 16 })
                  .optionFont({ size: 16 })
                  .width("100%")
                  .height(48)
                  .onSelect((index: number, value: string) => {
                    this.expenseType = value;
                  })
              }

              // 2. é‡‘é¢è¾“å…¥ï¼ˆæ–‡æœ¬è¾“å…¥ + æ ¡éªŒï¼‰
              FormCard({ title: "é‡‘é¢ï¼ˆå…ƒï¼‰*" }) {
                Column() {
                  TextInput({ placeholder: "0.00", text: this.amount })
                    .fontSize(24)
                    .fontWeight(FontWeight.Bold)
                    .fontColor("#F53F3F")
                    .width("100%")
                    .height(48)
                    .backgroundColor(Color.Transparent)
                    .type(InputType.Number) // ä¿®æ­£ä¸º type
                    .onChange((value: string) => {
                      this.amount = value;
                      this.validateAmount();
                    })
                  
                  if (this.amountError) {
                    Text(this.amountError)
                      .fontSize(12)
                      .fontColor("#F53F3F")
                      .margin({ top: 4 })
                  }
                }
              }

              // 3. æ—¥æœŸé€‰æ‹©ï¼ˆæ—¥æœŸé€‰æ‹©å™¨ï¼‰
              FormCard({ title: "æ—¥æœŸ" }) {
                Row() {
                  Text(this.dateStr)
                    .fontSize(16)
                    .fontColor("#333333")
                  Blank()
                  // ä½¿ç”¨Textä»£æ›¿Imageä½œä¸ºå›¾æ ‡ï¼Œå› ä¸ºæ²¡æœ‰èµ„æº
                  Text("ğŸ“…") 
                    .fontSize(20)
                }
                .width("100%")
                .height(40)
                .alignItems(VerticalAlign.Center)
                .onClick(() => {
                  this.showDatePicker();
                })
              }

              // 4. æ”¯ä»˜æ–¹å¼ï¼ˆå•é€‰ Radioï¼‰
              FormCard({ title: "æ”¯ä»˜æ–¹å¼" }) {
                Flex({ wrap: FlexWrap.Wrap }) {
                  ForEach(this.payTypes, (type: string) => {
                    Row() {
                      Radio({ value: type, group: "payType" })
                        .checked(this.payType === type)
                        .onChange((isChecked: boolean) => {
                          if (isChecked) {
                            this.payType = type;
                          }
                        })
                      Text(type)
                        .fontSize(14)
                        .fontColor("#333333")
                        .onClick(() => {
                           this.payType = type;
                        })
                    }
                    .margin({ right: 16, bottom: 8 })
                  })
                }
              }

              // 5. æ ‡ç­¾ï¼ˆå¤šé€‰ Checkboxï¼‰
              FormCard({ title: "æ ‡ç­¾" }) {
                Flex({ wrap: FlexWrap.Wrap }) {
                  ForEach(this.tagOptions, (tag: string) => {
                    Row() {
                      Checkbox({ name: tag, group: "tags" })
                        .select(this.tags.includes(tag))
                        .onChange((isChecked: boolean) => {
                          if (isChecked) {
                            this.tags.push(tag);
                          } else {
                            this.tags = this.tags.filter(t => t !== tag);
                          }
                        })
                      Text(tag)
                        .fontSize(14)
                        .fontColor("#333333")
                        .onClick(() => {
                          // ç®€å•çš„ç‚¹å‡»æ–‡å­—ä¹Ÿèƒ½åˆ‡æ¢é€‰ä¸­çŠ¶æ€é€»è¾‘æ¯”è¾ƒå¤æ‚ï¼Œè¿™é‡Œç®€åŒ–
                        })
                    }
                    .margin({ right: 12, bottom: 8 })
                  })
                }
              }

              // 6. æ˜¯å¦æŠ¥é”€ï¼ˆSwitch å¼€å…³ï¼‰
              FormCard({ title: "å…¶ä»–é€‰é¡¹" }) {
                Row() {
                  Text("æ˜¯å¦æŠ¥é”€")
                    .fontSize(16)
                    .fontColor("#333333")
                  Blank()
                  Toggle({ type: ToggleType.Switch, isOn: this.isReimbursable })
                    .onChange((isOn: boolean) => {
                      this.isReimbursable = isOn;
                    })
                }
                .width("100%")
                .height(40)
                .alignItems(VerticalAlign.Center)
              }

              // 7. å¤‡æ³¨ï¼ˆå¤šè¡Œæ–‡æœ¬è¾“å…¥ï¼‰
              FormCard({ title: "å¤‡æ³¨" }) {
                TextArea({ placeholder: "å†™ç‚¹ä»€ä¹ˆ...", text: this.note })
                  .fontSize(14)
                  .width("100%")
                  .height(80)
                  .backgroundColor("#F5F7FA")
                  .borderRadius(8)
                  .onChange((value: string) => {
                    this.note = value;
                  })
              }

              // æäº¤æŒ‰é’®
              Button(this.editingBillId > 0 ? "ä¿å­˜ä¿®æ”¹" : "è®°ä¸€ç¬”")
                .width("100%")
                .height(50)
                .linearGradient({
                  angle: 90,
                  colors: [[0x4A6CF7, 0.0], [0x4E54C8, 1.0]]
                })
                .fontColor(Color.White)
                .fontSize(18)
                .fontWeight(FontWeight.Bold)
                .borderRadius(25)
                .shadow({ radius: 8, color: "#4D4A6CF7", offsetY: 4 })
                .onClick(() => this.addBill())
                .margin({ top: 16, bottom: this.editingBillId > 0 ? 16 : 32 })

              if (this.editingBillId > 0) {
                Button("å–æ¶ˆä¿®æ”¹")
                  .width("100%")
                  .height(50)
                  .backgroundColor("#F0F2F5")
                  .fontColor("#666666")
                  .fontSize(18)
                  .fontWeight(FontWeight.Bold)
                  .borderRadius(25)
                  .onClick(() => this.resetForm())
                  .margin({ bottom: 32 })
              }
            }
            .padding(16)
          }
          .width("100%")
          .height("100%")
          .backgroundColor("#F9FAFB")
        }
        .tabBar(this.TabBuilder("è®°è´¦", 0, "ğŸ–Šï¸"))

        // æ ‡ç­¾é¡µ2ï¼šæ˜ç»†åˆ—è¡¨
        TabContent() {
          Column() {
            // æœç´¢æ 
            Row() {
              Search({ value: this.searchText, placeholder: 'æœç´¢åˆ†ç±»ã€å¤‡æ³¨ã€é‡‘é¢æˆ–æ ‡ç­¾' })
                .width('100%')
                .height(40)
                .backgroundColor(Color.White)
                .placeholderColor('#999999')
                .placeholderFont({ size: 14 })
                .textFont({ size: 14 })
                .onChange((value: string) => {
                  this.searchText = value;
                })
            }
            .width("100%")
            .padding({ left: 16, right: 16, top: 12, bottom: 8 })

            if (this.billList.length === 0) {
              // ç©ºçŠ¶æ€
              Column() {
                // ä½¿ç”¨Textä»£æ›¿Imageä½œä¸ºç©ºçŠ¶æ€å›¾æ ‡
                Text("ğŸ“")
                  .fontSize(60)
                  .margin({ bottom: 16 })
                Text("è¿˜æ²¡æœ‰è´¦å•å“¦ï¼Œå¿«å»è®°ä¸€ç¬”å§")
                  .fontSize(14)
                  .fontColor("#999999")
              }
              .width("100%")
              .height("60%")
              .justifyContent(FlexAlign.Center)
              .alignItems(HorizontalAlign.Center)
            } else {
              // è´¦å•åˆ—è¡¨ï¼ˆåˆ†ç»„æ˜¾ç¤ºï¼‰
              List({ space: 0 }) {
                ForEach(this.getGroupedBills(), (group: DayGroup) => {
                  ListItemGroup({ header: this.groupHeader(group) }) {
                    ForEach(group.bills, (bill: BillItem) => {
                      ListItem() {
                        Row() {
                          // å·¦ä¾§ï¼šå›¾æ ‡æˆ–ç±»å‹é¦–å­—
                          Column() {
                            Text(bill.type.substring(0, 1))
                              .fontSize(18)
                              .fontWeight(FontWeight.Bold)
                              .fontColor(Color.White)
                          }
                          .width(40)
                          .height(40)
                          .borderRadius(20)
                          .backgroundColor(this.getCategoryColor(bill.type))
                          .justifyContent(FlexAlign.Center)
                          .alignItems(HorizontalAlign.Center)
                          .margin({ right: 12 })

                          // ä¸­é—´ï¼šä¿¡æ¯
                          Column({ space: 4 }) {
                            Row({ space: 8 }) {
                              Text(bill.type)
                                .fontSize(16)
                                .fontWeight(FontWeight.Medium)
                                .fontColor("#333333")
                                .maxLines(1)
                                .textOverflow({ overflow: TextOverflow.Ellipsis })
                                .layoutWeight(1)
                              if (bill.isReimbursable) {
                                Text("æŠ¥é”€")
                                  .fontSize(10)
                                  .fontColor("#4A6CF7")
                                  .backgroundColor("#E6EAFB")
                                  .padding({ left: 4, right: 4, top: 2, bottom: 2 })
                                  .borderRadius(4)
                                  .flexShrink(0)
                              }
                            }
                            .width("100%")
                            
                            Text(`${bill.date} Â· ${bill.payType}`)
                              .fontSize(12)
                              .fontColor("#999999")
                              .width("100%")
                              .maxLines(1)
                              .textOverflow({ overflow: TextOverflow.Ellipsis })
                            
                            if (bill.note) {
                              Text(bill.note)
                                .fontSize(12)
                                .fontColor("#666666")
                                .width("100%")
                                .maxLines(1)
                                .textOverflow({ overflow: TextOverflow.Ellipsis })
                                .margin({ top: 4 })
                            }
                          }
                          .layoutWeight(1)

                          // å³ä¾§ï¼šé‡‘é¢
                          Column({ space: 4 }) {
                            Text(`${bill.direction === 'expense' ? '-' : '+'} ${bill.amount.toFixed(2)}`)
                              .fontSize(18)
                              .fontWeight(FontWeight.Bold)
                              .fontColor(bill.direction === 'expense' ? "#333333" : "#34C759")
                              .maxLines(1)
                              .textOverflow({ overflow: TextOverflow.Ellipsis })
                            
                            if (bill.tags.length > 0) {
                              Text(bill.tags.join(" "))
                                .fontSize(12)
                                .fontColor("#999999")
                                .maxLines(1)
                                .textOverflow({ overflow: TextOverflow.Ellipsis })
                            }
                          }
                          .alignItems(HorizontalAlign.End)
                          .flexShrink(0)
                          .constraintSize({ maxWidth: "40%" })
                        }
                        .width("100%")
                        .padding(16)
                        .backgroundColor(Color.White)
                        .borderRadius(12)
                        .shadow({ radius: 4, color: "#0D000000", offsetY: 2 }) // ä¼˜åŒ–é˜´å½±
                        .onClick(() => {
                          ActionSheet.show({
                            title: 'è´¦å•æ“ä½œ',
                            message: `ç±»å‹ï¼š${bill.type}  é‡‘é¢ï¼š${bill.amount.toFixed(2)}`,
                            autoCancel: true,
                            alignment: DialogAlignment.Bottom,
                            offset: { dx: 0, dy: -10 },
                            sheets: [
                              {
                                title: 'ç¼–è¾‘',
                                action: () => {
                                  this.startEdit(bill);
                                }
                              },
                              {
                                title: 'åˆ é™¤',
                                action: () => {
                                  this.deleteBill(bill.id);
                                }
                              }
                            ]
                          })
                        })
                      }
                      .swipeAction({ end: this.itemEnd(bill.id) })
                      .margin({ bottom: 12 })
                    })
                  }
                })
              }
              .width("100%")
              .layoutWeight(1)
              .padding({ left: 16, right: 16, bottom: 16 })
              .scrollBar(BarState.Auto) // æ˜¾ç¤ºæ»šåŠ¨æ¡
              .sticky(StickyStyle.Header)
            }
          }
          .width("100%")
          .height("100%")
          .backgroundColor("#F9FAFB")
        }
        .tabBar(this.TabBuilder("æ˜ç»†", 1, "ğŸ“„"))

        // æ ‡ç­¾é¡µ3ï¼šç»Ÿè®¡
        TabContent() {
          Column() {
            // å¤´éƒ¨ï¼šæ—¥æœŸé€‰æ‹©
            Row() {
              Text(`${this.statsDate.getFullYear()}å¹´${this.statsDate.getMonth() + 1}æœˆ`)
                .fontSize(18)
                .fontWeight(FontWeight.Bold)
                .fontColor("#333333")
              
              Image($r('app.media.layered_image')) // æš‚æ—¶ç”¨è¿™ä¸ªå›¾æ ‡ä»£æ›¿ä¸‹æ‹‰ç®­å¤´ï¼Œæˆ–è€…ç›´æ¥ç”¨æ–‡å­—
                .width(16)
                .height(16)
                .margin({ left: 4 })
                .fillColor("#333333") // å°è¯•ç€è‰²ï¼Œå¦‚æœä¸æ”¯æŒä¼šè‡ªåŠ¨å¿½ç•¥
            }
            .width("100%")
            .padding({ left: 16, right: 16, top: 16, bottom: 8 })
            .onClick(() => {
              this.showStatsDatePicker();
            })

            // æ¦‚è§ˆå¡ç‰‡
            Row() {
              Column() {
                Text("æ”¶å…¥")
                  .fontSize(12)
                  .fontColor("#999999")
                Text(`+${this.getMonthlyStats().totalIncome.toFixed(2)}`)
                  .fontSize(16)
                  .fontWeight(FontWeight.Bold)
                  .fontColor("#34C759")
                  .margin({ top: 4 })
              }
              .layoutWeight(1)
              .alignItems(HorizontalAlign.Center)

              Divider().vertical(true).height(30).color("#E0E0E0")

              Column() {
                Text("æ”¯å‡º")
                  .fontSize(12)
                  .fontColor("#999999")
                Text(`-${this.getMonthlyStats().totalExpense.toFixed(2)}`)
                  .fontSize(16)
                  .fontWeight(FontWeight.Bold)
                  .fontColor("#333333")
                  .margin({ top: 4 })
              }
              .layoutWeight(1)
              .alignItems(HorizontalAlign.Center)

              Divider().vertical(true).height(30).color("#E0E0E0")

              Column() {
                Text("ç»“ä½™")
                  .fontSize(12)
                  .fontColor("#999999")
                Text(`${this.getMonthlyStats().balance.toFixed(2)}`)
                  .fontSize(16)
                  .fontWeight(FontWeight.Bold)
                  .fontColor("#4A6CF7")
                  .margin({ top: 4 })
              }
              .layoutWeight(1)
              .alignItems(HorizontalAlign.Center)
            }
            .width("92%")
            .padding(16)
            .backgroundColor(Color.White)
            .borderRadius(12)
            .margin({ bottom: 16 })
            .shadow({ radius: 4, color: "#0D000000", offsetY: 2 }) // ä¼˜åŒ–é˜´å½±

            // æ”¶æ”¯åˆ‡æ¢
            Row() {
              Button("æ”¯å‡ºåˆ†æ")
                .type(ButtonType.Normal)
                .backgroundColor(this.statsType === 'expense' ? "#4A6CF7" : "#F0F2F5")
                .fontColor(this.statsType === 'expense' ? Color.White : "#666666")
                .borderRadius({ topLeft: 8, bottomLeft: 8 })
                .width("50%")
                .height(32)
                .onClick(() => {
                  this.statsType = 'expense';
                  this.drawPieChart();
                  this.drawBarChart();
                })
              
              Button("æ”¶å…¥åˆ†æ")
                .type(ButtonType.Normal)
                .backgroundColor(this.statsType === 'income' ? "#34C759" : "#F0F2F5")
                .fontColor(this.statsType === 'income' ? Color.White : "#666666")
                .borderRadius({ topRight: 8, bottomRight: 8 })
                .width("50%")
                .height(32)
                .onClick(() => {
                  this.statsType = 'income';
                  this.drawPieChart();
                  this.drawBarChart();
                })
            }
            .width("92%")
            .margin({ bottom: 16 })

            // é¥¼å›¾ Canvas
            Column() {
              Text("åˆ†ç±»å æ¯”")
                .fontSize(14)
                .fontColor("#666666")
                .width("100%")
                .margin({ bottom: 8 })

              Canvas(this.context)
                .width("100%")
                .height(200)
                .onReady(() => {
                  this.drawPieChart();
                })
                .onAreaChange(() => {
                   this.drawPieChart();
                })
            }
            .width("92%")
            .padding(16)
            .backgroundColor(Color.White)
            .borderRadius(12)
            .margin({ bottom: 16 })
            .shadow({ radius: 4, color: "#0D000000", offsetY: 2 })

            // æ¯æ—¥è¶‹åŠ¿ Canvas
            Column() {
              Text("æ¯æ—¥è¶‹åŠ¿")
                .fontSize(14)
                .fontColor("#666666")
                .width("100%")
                .margin({ bottom: 8 })

              Canvas(this.barContext)
                .width("100%")
                .height(150)
                .onReady(() => {
                  this.drawBarChart();
                })
                .onAreaChange(() => {
                   this.drawBarChart();
                })
            }
            .width("92%")
            .padding(16)
            .backgroundColor(Color.White)
            .borderRadius(12)
            .margin({ bottom: 16 })
            .shadow({ radius: 4, color: "#0D000000", offsetY: 2 })

            // åˆ†ç±»åˆ—è¡¨
            List() {
              ForEach(this.getPieData(), (item: PieData) => {
                ListItem() {
                  Row() {
                    // Color dot
                    Circle({ width: 10, height: 10 })
                      .fill(item.color)
                      .margin({ right: 8 })
                    
                    Text(item.category)
                      .fontSize(14)
                      .fontColor("#333333")
                      .layoutWeight(1)
                    
                    Text(`${(item.percentage * 100).toFixed(1)}%`)
                      .fontSize(14)
                      .fontColor("#666666")
                      .margin({ right: 16 })
                    
                    Text(item.amount.toFixed(2))
                      .fontSize(14)
                      .fontWeight(FontWeight.Bold)
                      .fontColor("#333333")
                  }
                  .width("100%")
                  .padding({ top: 12, bottom: 12 })
                  .border({ width: { bottom: 1 }, color: "#F0F0F0" })
                }
              })
            }
            .width("92%")
            .layoutWeight(1)
            .backgroundColor(Color.White)
            .borderRadius(12)
            .padding(16)
            .shadow({ radius: 4, color: "#0D000000", offsetY: 2 }) // ä¼˜åŒ–é˜´å½±
          }
          .width("100%")
          .height("100%")
          .backgroundColor("#F9FAFB")
          .alignItems(HorizontalAlign.Center)
        }
        .tabBar(this.TabBuilder("ç»Ÿè®¡", 2, "ğŸ“Š"))
      }
      .barWidth("100%")
      .barHeight(60)
      .backgroundColor(Color.White)
      .layoutWeight(1) // ç¡®ä¿Tabså æ®å‰©ä½™ç©ºé—´ï¼Œé¿å…è¢«é¡¶éƒ¨æ ‡é¢˜æ æŒ¤å‡ºå±å¹•
      .onChange((index: number) => {
        this.currentTab = index;
      })
    }
    .width("100%")
    .height("100%")
    .backgroundColor("#F9FAFB")
  }
}
